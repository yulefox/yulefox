---
title: 视野
layout: post
categories: dev
tags: 开发 C++ 测试
published: true

---

## 视野规则

* 最简单的视野实现是以对象坐标为圆心的一个圆形区域。为减轻服务器负载，服务器端视野的计算以格子为单位。
* 视野外的对象不可见，同一阵营的对象共享视野（通常情况下互相可见），不同阵营的对象无法共享视野。
* 视野可能因下面的遮挡、开启规则而改变

    {% codeblock lang:cpp %}
    enum FogMode {
        FOG_MODE_NONE,          // no fog, it is visible for the whole map
        FOG_MODE_BLACK,         // black fog, terrain invisible
        FOG_MODE_WAR,           // war fog, terrain visible
    };
    {% endcodeblock %}

![Enable/Disable View Fog](/images/view_agents_fog.png)

### 阵营

* 中立
* A
* B

    {% codeblock lang:cpp %}
    enum CampType {
        CAMP_TYPE_N, // neutral camp 
        CAMP_TYPE_A, // camp A
        CAMP_TYPE_B, // camp B
        CAMP_TYPE_MAX,
    };
    {% endcodeblock %}

### 视野遮挡规则

* 具有一定高度的视野障碍物（墙体、山体、草丛等）对视线遮挡造成视野范围缩小
* 具有掩蔽效果的掩蔽体（迷雾、草丛、特定潜行区域等）可令其中的目标对外界（一般仅针对敌对阵营）不可见
* 处于潜行、隐身状态的特定对象对外界（一般仅针对敌对阵营）不可见
* 迷雾、致盲等效果可令对象视野缩小或完全不可见

视野的遮挡规则通过 *过滤器* 实现。

#### 视野过滤

没有过滤器的情况下，一个对象的视野是被圆形区域包围的格子集合。

每一种过滤器均会根据对应规则过滤掉部分格子。

    {% codeblock lang:cpp %}
    enum FilterMode
    {
        FILTER_MODE_NONE             = 0x00000000,
        FILTER_MODE_INVISIBLE_SHAPE  = 0x00000001,
        FILTER_MODE_VIEW_BLOCK       = 0x00000002,
        FILTER_MODE_GRASS            = 0x00000004,
        FILTER_MODE_ALL              = -1,
    };
    {% endcodeblock %}

    {% codeblock lang:cpp %}
    // Calculate the view field of the shape/camp.
    if (view->last != idx) {
        UpdateView(view);
        FilterView(view);
        UpdateTile(shape, view);
    }
    {% endcodeblock %}

![View Filter](images/view_block_rays.jpg)

### 视野开启规则

为使视野具有连续性，避免造成闪烁，可考虑仅在客户端添加延迟移除视野显示的功能。

视野的开启需要借助具体对象实现，为之添加视野范围（目前仅考虑支持圆形视野，矢量视野等特性因暂无需求可不予考虑）属性，可为其自身及所属阵营开启视野。

* 角色、宠物、NPC 等具有视野的对象
* 通过技能、道具等创建的具有视野的对象（静止、移动）

### 视野实现

    {% codeblock lang:cpp %}
    struct view_t {
        int tile; // the index of the tile
        int last; // the index of the last tile
        int size; // the size of the view
        int anti_stealth; // the property of anti-stealth
        point_t pos; // the position of the shape
        CampType camp; // the camp of the view
        object_view_t field; // the cells of the view field
    };
    {% endcodeblock %}

#### 反潜行视野

由于共享视野可能造成视野叠加，为正确实现视野变化，目前设计为视野添加了引用计数。

由于潜行、隐身等状态的存在，必然存在反潜行、隐身等具有真视效果的视野。目前考虑的实现方案是为视野添加反潜行属性。

为了区分普通视野及真视视野，为真视视野对应格子的引用计数叠加一个极大值 `0x00010000`。

    {% codeblock lang:cpp %}
    const int Map::VIEW_REFERENCE[2] = {1, 0x00010000};
    {% endcodeblock %}

### 实现注意事项

* 需要明确视野不可见、目标不可见在实现方式上的区别
  * 视野：场景
  * 隐身：对象

## 场景

### 场景初始化及释放

基于场景模版（场景网格数据）创建场景对象。

    {% codeblock lang:cpp %}
    Map::Init();
    Map *map = Map::Create(id);
    Map::Fini();
    {% endcodeblock %}

### 添加对象

在场景初始化之后，即可往场景上添加可见的物体对象（`Shape`），以玩家对象为例：

* 创建对象；
* 设置阵营；
* 设置坐标/加入场景。

    {% codeblock lang:cpp %}
    Player *player = static_cast<Player *>(GetObjectManager().
            Create(OBJECT_TYPE_PLAYER));

    player->Set("camp", (Map::CampType)camp);

    map->SetPosition(player, (const point_t &)pos);
    {% endcodeblock %}

    {% codeblock lang:cpp %}
    // 1. The shape is a new one. Add it to the current map.
    // 2. The shape is on another map. Remove it from the last map and add it
    //    to the current.
    // 3. The shape is on the current map already. Remove the last flags.

    // Calculate the view field of the shape/camp.
    if (view->last != idx) {
        UpdateView(view);
        FilterView(view);
        UpdateTile(shape, view);
    }
    {% endcodeblock %}


### 场景对象管理

    {% codeblock lang:cpp %}
    ELF_INL const shape_map &GetShapes(void) const { return _shapes; }
    void GetShapes(Map::CampType camp, object_list &shapes) const;
    bool Has(const Shape *shape) const;

    void RemoveShape(Shape *shape);
    void SetPosition(Shape *shape, const point_t &pos);
    const object_view_t &GetObjectView(const Shape *shape) const;
    const camp_view_t &GetCampView(Map::CampType camp) const;

    shape_map _shapes; // all shapes on the map
    tile_shape_map _tile_shapes; // all shapes on the tiles
    camp_view_t _camp_vews[CAMP_TYPE_MAX]; // views of the camps
    {% endcodeblock %}

## 网络通信实现

视野变化仅影响客户端显示及玩家游戏感受，对于服务器逻辑没有影响。

